<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Kivi's Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Kivi&#039;s Blog"><meta name="msapplication-TileImage" content="/about/github.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Kivi&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="一、依赖解析流程说明1）通过DefaultModelBuilder#build生成当前pom的Model，也就是effective pom。 2）递归解析（深度遍历）effective pom的child dependency，生成effective pom。"><meta property="og:type" content="blog"><meta property="og:title" content="Maven源码-依赖解析"><meta property="og:url" content="https://kivihub.github.io/2022/01/25/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/"><meta property="og:site_name" content="Kivi&#039;s Blog"><meta property="og:description" content="一、依赖解析流程说明1）通过DefaultModelBuilder#build生成当前pom的Model，也就是effective pom。 2）递归解析（深度遍历）effective pom的child dependency，生成effective pom。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://kivihub.github.io/thumbnail/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/image-20210922140350158.png"><meta property="article:published_time" content="2022-01-25T13:14:04.000Z"><meta property="article:modified_time" content="2025-10-29T10:54:23.076Z"><meta property="article:author" content="Kivi"><meta property="article:tag" content="Blog"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://kivihub.github.io/thumbnail/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/image-20210922140350158.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://kivihub.github.io/2022/01/25/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/"},"headline":"Maven源码-依赖解析","image":["https://kivihub.github.io/thumbnail/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/image-20210922140350158.png"],"datePublished":"2022-01-25T13:14:04.000Z","dateModified":"2025-10-29T10:54:23.076Z","author":{"@type":"Person","name":"Kivi"},"publisher":{"@type":"Organization","name":"Kivi's Blog","logo":{"@type":"ImageObject"}},"description":"一、依赖解析流程说明1）通过DefaultModelBuilder#build生成当前pom的Model，也就是effective pom。 2）递归解析（深度遍历）effective pom的child dependency，生成effective pom。"}</script><link rel="canonical" href="https://kivihub.github.io/2022/01/25/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/"><link rel="icon" href="/about/github.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?18875f49bd2f905d572a26a7796c193b";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><script src="https://www.googletagmanager.com/gtag/js?id=G-H16FQ6QJL5" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-H16FQ6QJL5');</script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Kivi&#039;s Blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/catalog">目录</a><a class="navbar-item" href="/about">留言板</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/kivihub/kivihub-blog"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-01-25T13:14:04.000Z" title="1/25/2022, 9:14:04 PM">2022-01-25</time>发表</span><span class="level-item"><a class="link-muted" href="/categories/Java/">Java</a><span> / </span><a class="link-muted" href="/categories/Java/Maven/">Maven</a></span><span class="level-item">13 分钟读完 (大约1954个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Maven源码-依赖解析</h1><div class="content"><h2 id="一、依赖解析流程说明"><a href="#一、依赖解析流程说明" class="headerlink" title="一、依赖解析流程说明"></a>一、依赖解析流程说明</h2><p>1）通过<code>DefaultModelBuilder#build</code>生成当前pom的Model，也就是<code>effective pom</code>。</p>
<p>2）递归解析（深度遍历）<code>effective pom</code>的child dependency，生成<code>effective pom</code>。</p>
<span id="more"></span>

<h2 id="二、生成effective-pom"><a href="#二、生成effective-pom" class="headerlink" title="二、生成effective pom"></a>二、生成effective pom</h2><blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://maven.apache.org/ref/3.8.4/maven-model-builder/">https://maven.apache.org/ref/3.8.4/maven-model-builder/</a></p>
<p>源码：org.apache.maven.model.building.DefaultModelBuilder#build</p>
</blockquote>
<h3 id="阶段1"><a href="#阶段1" class="headerlink" title="阶段1"></a>阶段1</h3><h4 id="1、profile-activation"><a href="#1、profile-activation" class="headerlink" title="1、profile activation"></a>1、profile activation</h4><p>从命令行指定激活的profile</p>
<h4 id="2、raw-model-validation"><a href="#2、raw-model-validation" class="headerlink" title="2、raw model validation"></a>2、raw model validation</h4><p>当前pom的Raw model校验</p>
<h4 id="3、model-normalization"><a href="#3、model-normalization" class="headerlink" title="3、model normalization"></a>3、model normalization</h4><p>当前pom的model规范化，合并重复声明的依赖</p>
<h4 id="4、profile-injection"><a href="#4、profile-injection" class="headerlink" title="4、profile injection"></a>4、profile injection</h4><p>把激活态profile（命令行指定激活的或者POM中默认激活的）内容合并注入到model中，如配置、依赖等。</p>
<h4 id="5、parent-resolution-until-super-pom"><a href="#5、parent-resolution-until-super-pom" class="headerlink" title="5、parent resolution until super-pom"></a>5、parent resolution until super-pom</h4><p>解析当前pom的父POM的model直到SuperPOM。解析完后，lineage内的对象如下。</p>
<p><img src="/2022/01/25/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/pic/image-20210922140350158.png" alt="image-20210922140350158"></p>
<p>源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Collection&lt;String&gt; parentIds = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(); <span class="comment">// 用来判断循环解析</span></span><br><span class="line">List&lt;ModelData&gt; lineage = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">// 用来保存当前pom到super-pom mode的列表</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">ModelData</span> <span class="variable">currentData</span> <span class="operator">=</span> resultData; currentData != <span class="literal">null</span>;) &#123;</span><br><span class="line">    lineage.add(currentData);</span><br><span class="line">    <span class="type">Model</span> <span class="variable">rawModel</span> <span class="operator">=</span> currentData.getModel();</span><br><span class="line">    currentData.setRawModel(rawModel);</span><br><span class="line">    <span class="type">Model</span> <span class="variable">tmpModel</span> <span class="operator">=</span> rawModel.clone();</span><br><span class="line">    currentData.setModel(tmpModel);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// model normalization, 去重</span></span><br><span class="line">    modelNormalizer.mergeDuplicates( tmpModel, request, problems );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前POM是超级POM时Break</span></span><br><span class="line">    <span class="keyword">if</span> (currentData == superData) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    configureResolver( request.getModelResolver(), tmpModel, problems );</span><br><span class="line">    <span class="type">ModelData</span> <span class="variable">parentData</span> <span class="operator">=</span> readParent(tmpModel, currentData.getSource(), request, problems);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使迭代依次向上找父POM，把他们放入lineage集合内</span></span><br><span class="line">    <span class="keyword">if</span> ( parentData == <span class="literal">null</span> ) &#123;</span><br><span class="line">        currentData = superData;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( currentData == resultData ) &#123; <span class="comment">// 首次迭代，设置pom的继承属性</span></span><br><span class="line">        currentData.setGroupId(currentData.getRawModel().getGroupId() == <span class="literal">null</span> ? parentData.getGroupId() : currentData.getRawModel().getGroupId());</span><br><span class="line">        currentData.setVersion(currentData.getRawModel().getVersion() == <span class="literal">null</span> ? parentData.getVersion() : currentData.getRawModel().getVersion());</span><br><span class="line">        currentData.setArtifactId(currentData.getRawModel().getArtifactId());</span><br><span class="line">        parentIds.add(currentData.getId()); <span class="comment">// 入口POM加入parentIds</span></span><br><span class="line"></span><br><span class="line">        currentData = parentData;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!parentIds.add( parentData.getId())) &#123; <span class="comment">// 判断父POM循环</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;The parents form a cycle&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        currentData = parentData;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6、inheritance-assembly"><a href="#6、inheritance-assembly" class="headerlink" title="6、inheritance assembly"></a>6、inheritance assembly</h4><p>当前pom的model继承合并父POM的配置和依赖等内容。遍历lineage对model进行聚合，从后往前聚合，如下图：</p>
<p><img src="/2022/01/25/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/pic/image-20210922140645047.png" alt="image-20210922140645047"></p>
<p>参考源码：<em>org.apache.maven.model.merge.ModelMerger#mergeModel</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">mergeModel</span><span class="params">( Model target, Model source, <span class="type">boolean</span> sourceDominant, Map&lt;Object, Object&gt; context )</span> &#123;</span><br><span class="line">    mergeModelBase( target, source, sourceDominant, context );</span><br><span class="line"></span><br><span class="line">    mergeModel_ChildProjectUrlInheritAppendPath( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_ModelVersion( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Parent( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_GroupId( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_ArtifactId( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Version( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Packaging( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Name( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Description( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Url( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_InceptionYear( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Organization( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Licenses( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_MailingLists( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Developers( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Contributors( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_IssueManagement( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Scm( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_CiManagement( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Prerequisites( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Build( target, source, sourceDominant, context );</span><br><span class="line">    mergeModel_Profiles( target, source, sourceDominant, context );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">mergeModelBase</span><span class="params">( ModelBase target, ModelBase source, <span class="type">boolean</span> sourceDominant, Map&lt;Object, Object&gt; context )</span> &#123;</span><br><span class="line">    mergeModelBase_DistributionManagement( target, source, sourceDominant, context );</span><br><span class="line">    mergeModelBase_Modules( target, source, sourceDominant, context );</span><br><span class="line">    mergeModelBase_Repositories( target, source, sourceDominant, context );</span><br><span class="line">    mergeModelBase_PluginRepositories( target, source, sourceDominant, context );</span><br><span class="line">    mergeModelBase_Dependencies( target, source, sourceDominant, context );</span><br><span class="line">    mergeModelBase_Reporting( target, source, sourceDominant, context );</span><br><span class="line">    mergeModelBase_DependencyManagement( target, source, sourceDominant, context );</span><br><span class="line">    mergeModelBase_Properties( target, source, sourceDominant, context );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7、model-interpolation"><a href="#7、model-interpolation" class="headerlink" title="7、model interpolation"></a>7、model interpolation</h4><p>当前pom的model进行变量解释。变量替换时遵循一定顺序（valueSources内的ValurSource顺序）从配置上下文里找。可参考：<a href="/2022/01/24/Maven属性替换">Maven属性替换</a></p>
<p>参考：<em>org.apache.maven.model.interpolation.StringVisitorModelInterpolator#interpolateModel</em></p>
<p><img src="/2022/01/25/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/pic/image-20220125184235160.png" alt="image-20220125184235160"></p>
<h4 id="8、url-normallization"><a href="#8、url-normallization" class="headerlink" title="8、url normallization"></a>8、url normallization</h4><p>Url规范化，如一些相对目录的替换。</p>
<h3 id="阶段2：可选的插件处理"><a href="#阶段2：可选的插件处理" class="headerlink" title="阶段2：可选的插件处理"></a>阶段2：可选的插件处理</h3><h4 id="1、model-path-translation"><a href="#1、model-path-translation" class="headerlink" title="1、model path translation"></a>1、model path translation</h4><p>模型中路径（如main路径、target路径等）解析，替换为当前操作系统的文件分隔符、路径分割。</p>
<h4 id="2、plugin-management-injection"><a href="#2、plugin-management-injection" class="headerlink" title="2、plugin management injection"></a>2、plugin management injection</h4><p>插件约束注入。</p>
<h4 id="3、-optional-lifecyle-bindings-injection"><a href="#3、-optional-lifecyle-bindings-injection" class="headerlink" title="3、(optional) lifecyle bindings injection"></a>3、(optional) lifecyle bindings injection</h4><p>生命周期绑定注入。合并默认插件至model，默认插件通过*lifecycle.getPluginsBoundByDefaultToAllLifecycles( packaging )*获取。</p>
<p><img src="/2022/01/25/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/pic/image-20220125191715397.png" alt="image-20220125191715397"></p>
<h4 id="4、dependency-management-import"><a href="#4、dependency-management-import" class="headerlink" title="4、dependency management import"></a>4、dependency management import</h4><p>解析model中<em>dependencyManagment</em>中的import依赖，并注入model。会触发import依赖的<em>effective pom</em>解析。</p>
<p>如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 第三方依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>person.kivihub<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>从<em>org.apache.maven.model.composition.DefaultDependencyManagementImporter</em>源码可看出是先声明的有效。</p>
<p>顺序：<strong>当前pom的dependencyManagment</strong> &gt; <strong>当前pom的dependency的import</strong> &gt; <strong>父pom中的dependencyManagement</strong>  &gt; <strong>父pom中的dependencyManagement的import</strong>。</p>
<h4 id="5、dependency-management-injection"><a href="#5、dependency-management-injection" class="headerlink" title="5、dependency management injection"></a>5、dependency management injection</h4><p>根据上一步解析出的依赖版本约束，修改model中依赖的版本。</p>
<p>源码：<em>org.apache.maven.model.management.DefaultDependencyManagementInjector#injectManagement</em></p>
<h4 id="6、model-normalization-inject-default-values"><a href="#6、model-normalization-inject-default-values" class="headerlink" title="6、model normalization - inject default values"></a>6、model normalization - inject default values</h4><p>给model中的dependency和plugin设置默认的scope — compile。</p>
<h4 id="7、-optional-report-configuration"><a href="#7、-optional-report-configuration" class="headerlink" title="7、(optional) report configuration"></a>7、(optional) report configuration</h4><h4 id="8、-optional-report-convesion-to-decoupled-site-plugin"><a href="#8、-optional-report-convesion-to-decoupled-site-plugin" class="headerlink" title="8、(optional) report convesion to decoupled site plugin"></a>8、(optional) report convesion to decoupled site plugin</h4><h4 id="9、-optional-plugins-configuration"><a href="#9、-optional-plugins-configuration" class="headerlink" title="9、(optional) plugins configuration"></a>9、(optional) plugins configuration</h4><h4 id="10、effective-model-validation"><a href="#10、effective-model-validation" class="headerlink" title="10、effective model validation"></a>10、effective model validation</h4><p>模型校验，如进行model的groupId，artifactId，version非空校验。</p>
<h2 id="三、递归解析子依赖"><a href="#三、递归解析子依赖" class="headerlink" title="三、递归解析子依赖"></a>三、递归解析子依赖</h2><blockquote>
<p> <em>MojoExecutor</em>执行Mojo前会调用<em>org.apache.maven.lifecycle.internal.MojoExecutor#ensureDependenciesAreResolved</em>进行依赖的递归解析。</p>
</blockquote>
<p><strong>Model是一个多叉数模型，递归解析的过程也是多叉树遍历的过程，Maven再进行解析时通过深度遍历来解析。</strong></p>
<p><img src="/2022/01/25/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/pic/image-20220126202817960.png" alt="image-20220126202817960"></p>
<p>观察上面堆栈，发现递归解析发生时逻辑主要在以下两个方法内：</p>
<p>1）<em>org.eclipse.aether.internal.impl.collect.DefaultDependencyCollector#processDependency</em></p>
<p>2）<em>org.eclipse.aether.internal.impl.collect.DefaultDependencyCollector#doRecurse</em></p>
<p>递归时需要的参数主要有以下内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* org.eclipse.aether.internal.impl.collect.DefaultDependencyCollector#process</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(<span class="keyword">final</span> Args args, // 入参，含session（含冲突协调器dependencyGraphTransformer）、trace、 </span></span><br><span class="line"><span class="params">                    Results results, </span></span><br><span class="line"><span class="params">                    List&lt;Dependency&gt; dependencies,    // 本次要遍历的直接依赖</span></span><br><span class="line"><span class="params">                    List&lt;RemoteRepository&gt; repositories,  // 远程仓库</span></span><br><span class="line"><span class="params">                    DependencySelector depSelector, // 依赖选择器，如scop选择器、optional选择器、exclude选择器。递归时会向下合并</span></span><br><span class="line"><span class="params">                    DependencyManager depManager, // 依赖版本管理</span></span><br><span class="line"><span class="params">                    DependencyTraverser depTraverser,  // 依赖访问者</span></span><br><span class="line"><span class="params">                    VersionFilter verFilter)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Dependency dependency : dependencies) &#123;</span><br><span class="line">        processDependency(args, results, repositories, depSelector, depManager, depTraverser, verFilter, dependency);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1、DefaultDependencyCollector-doRecurse"><a href="#1、DefaultDependencyCollector-doRecurse" class="headerlink" title="1、DefaultDependencyCollector#doRecurse"></a>1、DefaultDependencyCollector#doRecurse</h3><p>1）对<em>depSelector</em>、<em>depManager</em>、<em>depTraverser</em>、<em>verFilter</em>进行下钻式的合并，即子从父继承合并属性。</p>
<p>2）把当前处理的依赖放入栈：<em>Args.nodes</em>，该依赖解析完后弹出。可通过此栈观察当前遍历的路径和深度。</p>
<h3 id="2、DefaultDependencyCollector-processDependency"><a href="#2、DefaultDependencyCollector-processDependency" class="headerlink" title="2、DefaultDependencyCollector#processDependency"></a>2、DefaultDependencyCollector#processDependency</h3><p>1）根据<code>depSelector</code>对依赖进行判断是否忽略，如<em>ScopeDependencySelector</em>、<em>OptionalDependencySelector</em>、<em>ExclusionDependencySelector</em>。</p>
<p><img src="/2022/01/25/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/pic/image-20220126204838833.png" alt="image-20220126204838833"></p>
<p>2）根据<code>depManager</code>对依赖进行约束，也就是<em>dependencyManagement</em>标签里的内容。</p>
<p>3）根据<code>depTraverser</code>判断是否需要递归解析。</p>
<p>4）使用成员属性<code>descriptorReader</code>解析当前依赖的<em>effective pom</em>。其会调用<em>ModelBuilder#build</em>生成<em>effective pom</em>，执行两个phase。</p>
<p><img src="/2022/01/25/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/pic/image-20220126213026437.png" alt="image-20220126213026437"></p>
<p>5）判断是否是<code>relocation</code>，如果是，则进行重定向解析；如果不是，则进行下一步。</p>
<p>6）根据<code>depTraverser</code>结果，判断是否进行递归处理。如果需要递归处理则遍历<em>effective pom</em>的依赖，调用<strong>DefaultDependencyCollector#doRecurse</strong>方法</p>
<h3 id="3、递归解析图示"><a href="#3、递归解析图示" class="headerlink" title="3、递归解析图示"></a>3、递归解析图示</h3><p><img src="/2022/01/25/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/pic/image-20220127154542591.png" alt="image-20220127154542591"></p>
<h2 id="四、依赖调停"><a href="#四、依赖调停" class="headerlink" title="四、依赖调停"></a>四、依赖调停</h2><blockquote>
<p>递归解析完子依赖后，会获取一个依赖全集。下一步会调用<em>ChainedDependencyGraphTransformer#transformGraph</em>对依赖进行调停。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* org.eclipse.aether.internal.impl.collect.DefaultDependencyCollector</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> CollectResult <span class="title function_">collectDependencies</span><span class="params">(RepositorySystemSession session, CollectRequest request)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...递归解析部分...</span></span><br><span class="line"></span><br><span class="line">    <span class="type">DependencyGraphTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> session.getDependencyGraphTransformer();</span><br><span class="line">    <span class="keyword">if</span> (transformer != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DefaultDependencyGraphTransformationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultDependencyGraphTransformationContext</span>(session);</span><br><span class="line">            context.put(TransformationContextKeys.STATS, stats);</span><br><span class="line">            result.setRoot(transformer.transformGraph(node, context));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RepositoryException e) &#123;</span><br><span class="line">            result.addException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/25/Maven%E6%BA%90%E7%A0%81-%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90/pic/image-20220126215427312.png" alt="image-20220126215427312"></p>
<h3 id="ConflictResolver"><a href="#ConflictResolver" class="headerlink" title="ConflictResolver"></a>ConflictResolver</h3><blockquote>
<p>参考：org.eclipse.aether.util.graph.transformer.ConflictResolver#transformGraph</p>
</blockquote>
<p>1）<em>ConflictIdSorter#transformGraph</em>计算冲突的依赖，并设置到<em>context</em>内。</p>
<blockquote>
<p>org.eclipse.aether.util.graph.transformer.ConflictMarker#analyze</p>
</blockquote>
<p>深度遍历依赖树，把依赖按<code>gourp:artifact:classifier:extension</code>进行分组。</p>
<p>2）遍历依赖全集，根据上面的分组判断是否冲突；冲突的加入conflictIds。</p>
<p>3）遍历conflictIds，针对每个冲突都深度遍历依赖全集，获取所有冲突的依赖。</p>
<p>4）对冲突的依赖进行调停，依次调用：<em>VersionSelector</em>（默认实现NearestVersionSelector）、<em>ScopeSelector</em>、<em>OptionalitySelector</em>进行依赖调停。</p>
<h2 id="五、Maven和Aether"><a href="#五、Maven和Aether" class="headerlink" title="五、Maven和Aether"></a>五、Maven和Aether</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://maven.apache.org/aether.html">https://maven.apache.org/aether.html</a></p>
<p><a target="_blank" rel="noopener" href="https://wiki.eclipse.org/Aether/What_Is_Aether">https://wiki.eclipse.org/Aether/What_Is_Aether</a></p>
</blockquote>
<p>以上分析是基于<strong>Maven3.X</strong>，其依赖解析内容使用了<strong>Aether</strong>。该项目来自eclipse社区，后引入为<em>maven-resolver</em>项目，<em>edi-core</em>内也有部门实现类。</p>
<p><strong>Aether</strong>依赖解析说明参考<a target="_blank" rel="noopener" href="https://wiki.eclipse.org/Aether/Transitive_Dependency_Resolution">文章</a>，内容为以上流程的概要说明。</p>
</div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/01/27/Maven%E5%B9%B6%E8%A1%8C%E5%8F%82%E6%95%B0%E5%8A%A0%E5%BF%AB%E7%BC%96%E8%AF%91/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Maven并行参数加快编译</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/01/24/Maven%E5%B1%9E%E6%80%A7%E6%9B%BF%E6%8D%A2/"><span class="level-item">Maven属性替换</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card" id="comments"><div class="card-content"><h3 class="title is-5">评论</h3><script src="https://giscus.app/client.js" repo="kivihub/kivihub-blog" data-repo="kivihub/kivihub-blog" data-repo-id="MDEwOlJlcG9zaXRvcnkzMjk3MjM2NDk=" data-category-id="DIC_kwDOE6cvAc4CmtLD" data-category="Announcements" data-mapping="pathname" data-strict="0" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="top" data-theme="noborder_light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async></script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#一、依赖解析流程说明"><span class="level-left"><span class="level-item">一、依赖解析流程说明</span></span></a></li><li><a class="level is-mobile" href="#二、生成effective-pom"><span class="level-left"><span class="level-item">二、生成effective pom</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#阶段1"><span class="level-left"><span class="level-item">阶段1</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1、profile-activation"><span class="level-left"><span class="level-item">1、profile activation</span></span></a></li><li><a class="level is-mobile" href="#2、raw-model-validation"><span class="level-left"><span class="level-item">2、raw model validation</span></span></a></li><li><a class="level is-mobile" href="#3、model-normalization"><span class="level-left"><span class="level-item">3、model normalization</span></span></a></li><li><a class="level is-mobile" href="#4、profile-injection"><span class="level-left"><span class="level-item">4、profile injection</span></span></a></li><li><a class="level is-mobile" href="#5、parent-resolution-until-super-pom"><span class="level-left"><span class="level-item">5、parent resolution until super-pom</span></span></a></li><li><a class="level is-mobile" href="#6、inheritance-assembly"><span class="level-left"><span class="level-item">6、inheritance assembly</span></span></a></li><li><a class="level is-mobile" href="#7、model-interpolation"><span class="level-left"><span class="level-item">7、model interpolation</span></span></a></li><li><a class="level is-mobile" href="#8、url-normallization"><span class="level-left"><span class="level-item">8、url normallization</span></span></a></li></ul></li><li><a class="level is-mobile" href="#阶段2：可选的插件处理"><span class="level-left"><span class="level-item">阶段2：可选的插件处理</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1、model-path-translation"><span class="level-left"><span class="level-item">1、model path translation</span></span></a></li><li><a class="level is-mobile" href="#2、plugin-management-injection"><span class="level-left"><span class="level-item">2、plugin management injection</span></span></a></li><li><a class="level is-mobile" href="#3、-optional-lifecyle-bindings-injection"><span class="level-left"><span class="level-item">3、(optional) lifecyle bindings injection</span></span></a></li><li><a class="level is-mobile" href="#4、dependency-management-import"><span class="level-left"><span class="level-item">4、dependency management import</span></span></a></li><li><a class="level is-mobile" href="#5、dependency-management-injection"><span class="level-left"><span class="level-item">5、dependency management injection</span></span></a></li><li><a class="level is-mobile" href="#6、model-normalization-inject-default-values"><span class="level-left"><span class="level-item">6、model normalization - inject default values</span></span></a></li><li><a class="level is-mobile" href="#7、-optional-report-configuration"><span class="level-left"><span class="level-item">7、(optional) report configuration</span></span></a></li><li><a class="level is-mobile" href="#8、-optional-report-convesion-to-decoupled-site-plugin"><span class="level-left"><span class="level-item">8、(optional) report convesion to decoupled site plugin</span></span></a></li><li><a class="level is-mobile" href="#9、-optional-plugins-configuration"><span class="level-left"><span class="level-item">9、(optional) plugins configuration</span></span></a></li><li><a class="level is-mobile" href="#10、effective-model-validation"><span class="level-left"><span class="level-item">10、effective model validation</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#三、递归解析子依赖"><span class="level-left"><span class="level-item">三、递归解析子依赖</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1、DefaultDependencyCollector-doRecurse"><span class="level-left"><span class="level-item">1、DefaultDependencyCollector#doRecurse</span></span></a></li><li><a class="level is-mobile" href="#2、DefaultDependencyCollector-processDependency"><span class="level-left"><span class="level-item">2、DefaultDependencyCollector#processDependency</span></span></a></li><li><a class="level is-mobile" href="#3、递归解析图示"><span class="level-left"><span class="level-item">3、递归解析图示</span></span></a></li></ul></li><li><a class="level is-mobile" href="#四、依赖调停"><span class="level-left"><span class="level-item">四、依赖调停</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ConflictResolver"><span class="level-left"><span class="level-item">ConflictResolver</span></span></a></li></ul></li><li><a class="level is-mobile" href="#五、Maven和Aether"><span class="level-left"><span class="level-item">五、Maven和Aether</span></span></a></li></ul></div></div><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Kivi&#039;s Blog</a><p class="is-size-7"><span>&copy; 2025 Kivi</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p><p class="is-size-7">非学无以广才，非志无以成学</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/kivihub/kivihub-blog"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>